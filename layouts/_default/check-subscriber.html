{{ define "main" }}
<div class="check-subscriber-container">
  <div class="check-subscriber-content">
    <h1>Newsletter Subscription Status</h1>
    <div id="debug-info" style="background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 12px; color: #666;">
      <strong>Debug:</strong> Page loaded at <span id="load-time"></span> | Template: check-subscriber.html
    </div>
    
    <div id="user-info" class="user-info" style="display: none;">
      <div class="user-info-content">
        <div class="user-avatar">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        </div>
        <div class="user-details">
          <p class="user-name" id="userName"></p>
          <p class="user-email" id="userEmail"></p>
        </div>
      </div>
    </div>
    
    <div id="loading" class="status-message loading">
      <div class="loading-spinner"></div>
      <p>Checking your subscription status...</p>
    </div>
    
    <div id="status" class="status-message" style="display: none;">
      <!-- Status messages will be inserted here -->
    </div>
    
    <!-- Subscription Status Summary -->
    <div id="subscription-summary" class="subscription-summary" style="display: none;">
      <div class="summary-header">
        <h2>Subscription Status</h2>
      </div>
      <div class="summary-content">
        <div class="status-indicator" id="statusIndicator">
          <div class="status-icon" id="statusIcon"></div>
          <div class="status-text" id="statusText"></div>
        </div>
        <div class="status-details" id="statusDetails"></div>
      </div>
    </div>
    
    <div id="error" class="status-message error" style="display: none;">
      <p>‚ùå Unable to check subscription status. Please try again later.</p>
    </div>
    
    <div class="check-subscriber-action-buttons" style="display: none;">
      <a href="{{ .Site.BaseURL }}" class="check-subscriber-btn check-subscriber-btn-primary">Back to Home</a>
      <button id="subscribeBtn" class="check-subscriber-btn check-subscriber-btn-secondary" style="display: none;">Subscribe to Newsletter</button>
    </div>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', async function() {
  console.log('[check-subscriber] Page loaded, checking Auth0 authentication...');
  console.log('[check-subscriber] Current URL:', window.location.href);
  console.log('[check-subscriber] URL search params:', window.location.search);
  
  // Set debug info
  const loadTimeEl = document.getElementById('load-time');
  if (loadTimeEl) {
    loadTimeEl.textContent = new Date().toLocaleTimeString();
  }
  
  const loadingEl = document.getElementById('loading');
  const statusEl = document.getElementById('status');
  const errorEl = document.getElementById('error');
  const actionButtons = document.querySelector('.check-subscriber-action-buttons');
  const subscribeBtn = document.getElementById('subscribeBtn');
  const userInfoEl = document.getElementById('user-info');
  const userNameEl = document.getElementById('userName');
  const userEmailEl = document.getElementById('userEmail');
  const subscriptionSummaryEl = document.getElementById('subscription-summary');
  const statusIconEl = document.getElementById('statusIcon');
  const statusTextEl = document.getElementById('statusText');
  const statusDetailsEl = document.getElementById('statusDetails');
  
  try {
    // Wait for Auth0 to be available
    console.log('[check-subscriber] Waiting for Auth0 client...');
    await waitForAuth0();
    console.log('[check-subscriber] Auth0 client is available');
    
    // Get the authenticated user
    console.log('[check-subscriber] Getting user from Auth0...');
    let user;
    try {
      user = await auth0Client.getUser();
      console.log('[check-subscriber] Raw user data:', user);
      console.log('[check-subscriber] User type:', typeof user);
      console.log('[check-subscriber] User keys:', user ? Object.keys(user) : 'null');
      console.log('[check-subscriber] User email:', user?.email);
      console.log('[check-subscriber] User name:', user?.name);
      console.log('[check-subscriber] User nickname:', user?.nickname);
    } catch (authError) {
      console.error('[check-subscriber] Error getting user from Auth0:', authError);
      loadingEl.style.display = 'none';
      statusEl.style.display = 'block';
      statusEl.className = 'status-message error';
      statusEl.innerHTML = `
        <p>‚ùå <strong>Authentication Error</strong></p>
        <p>Unable to retrieve user information from Auth0.</p>
        <p><small>Error: ${authError.message}</small></p>
      `;
      actionButtons.style.display = 'flex';
      return;
    }
    
    if (!user || !user.email) {
      console.log('[check-subscriber] No authenticated user found, showing login prompt');
      // Show a message to login first
      loadingEl.style.display = 'none';
      statusEl.style.display = 'block';
      statusEl.className = 'status-message info';
      statusEl.innerHTML = `
        <p>üîê <strong>Please log in first</strong></p>
        <p>You need to be logged in to check your subscription status.</p>
        <a href="{{ .Site.BaseURL }}" class="check-subscriber-btn check-subscriber-btn-primary" style="margin-top: 1rem; display: inline-block;">Go to Home Page</a>
      `;
      actionButtons.style.display = 'flex';
      return;
    }
    
    // Display user information
    console.log('[check-subscriber] Displaying user info');
    
    // Try different ways to get user name and email
    const userName = user.name || user.nickname || user.given_name || user.family_name || 'User';
    const userEmail = user.email || user.email_verified || 'No email found';
    
    console.log('[check-subscriber] Final user name:', userName);
    console.log('[check-subscriber] Final user email:', userEmail);
    
    userNameEl.textContent = userName;
    userEmailEl.textContent = userEmail;
    userInfoEl.style.display = 'block';
    
    // Hide loading, show status
    loadingEl.style.display = 'none';
    statusEl.style.display = 'block';
    
    // Check subscription status
    if (user.email) {
      await checkSubscriptionStatus(user.email);
    } else {
      console.error('[check-subscriber] No email found in user object');
      statusEl.className = 'status-message error';
      statusEl.innerHTML = `
        <p>‚ùå <strong>No Email Found</strong></p>
        <p>Unable to find email address in user profile.</p>
        <p><small>User object keys: ${Object.keys(user).join(', ')}</small></p>
      `;
    }
    
  } catch (error) {
    console.error('[check-subscriber] Error:', error);
    
    loadingEl.style.display = 'none';
    
    // Show specific error message based on the error type
    if (error.message.includes('Auth0 client not available')) {
      statusEl.style.display = 'block';
      statusEl.className = 'status-message error';
      statusEl.innerHTML = `
        <p>üîß <strong>Auth0 Client Not Available</strong></p>
        <p>The authentication system is not loading properly. This could be due to:</p>
        <ul style="text-align: left; margin: 1rem 0;">
          <li>Script loading issues in production</li>
          <li>Auth0 configuration problems</li>
          <li>Content Security Policy restrictions</li>
        </ul>
        <p><strong>Debug Info:</strong></p>
        <p><small>URL: ${window.location.href}</small></p>
        <p><small>Error: ${error.message}</small></p>
        <p><small>Check console for detailed logs</small></p>
      `;
    } else {
      errorEl.style.display = 'block';
    }
    
    actionButtons.style.display = 'flex';
  }
});

async function waitForAuth0() {
  const maxAttempts = 30;
  let attempts = 0;
  
  console.log('[check-subscriber] Starting Auth0 client wait...');
  console.log('[check-subscriber] Available globals:', {
    auth0Client: typeof window.auth0Client,
    createAuth0Client: typeof window.createAuth0Client,
    auth0: typeof window.auth0,
    __AUTH0: !!window.__AUTH0
  });
  
  while (attempts < maxAttempts) {
    console.log(`[check-subscriber] Attempt ${attempts + 1}/${maxAttempts} - checking for Auth0 client...`);
    
    if (window.auth0Client && typeof window.auth0Client.getUser === 'function') {
      console.log('[check-subscriber] Auth0 client found!');
      return;
    }
    
    // Check for alternative Auth0 client locations
    if (window.auth && window.auth.auth0Client) {
      console.log('[check-subscriber] Found Auth0 client in window.auth');
      window.auth0Client = window.auth.auth0Client;
      return;
    }
    
    console.log('[check-subscriber] Auth0 client not ready, waiting...');
    await new Promise(resolve => setTimeout(resolve, 100));
    attempts++;
  }
  
  console.error('[check-subscriber] Auth0 client wait timeout');
  console.error('[check-subscriber] Final globals check:', {
    auth0Client: typeof window.auth0Client,
    createAuth0Client: typeof window.createAuth0Client,
    auth0: typeof window.auth0,
    __AUTH0: window.__AUTH0,
    auth: typeof window.auth
  });
  
  throw new Error('Auth0 client not available');
}

async function checkSubscriptionStatus(email) {
  console.log('[check-subscriber] Checking subscription for:', email);
  console.log('[check-subscriber] Making API call to: /.netlify/functions/check-subscriber');
  
  const statusEl = document.getElementById('status');
  const actionButtons = document.querySelector('.check-subscriber-action-buttons');
  const subscribeBtn = document.getElementById('subscribeBtn');
  
  try {
    console.log('[check-subscriber] Sending POST request with email:', email);
    
    const response = await fetch('/.netlify/functions/check-subscriber', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ email: email })
    });
    
    console.log('[check-subscriber] Response status:', response.status);
    console.log('[check-subscriber] Response headers:', response.headers);
    console.log('[check-subscriber] Response ok:', response.ok);
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error('[check-subscriber] Error response body:', errorText);
      throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
    }
    
    const data = await response.json();
    console.log('[check-subscriber] Parsed response data:', data);
    
    if (data.error) {
      throw new Error(data.error);
    }
    
    // Display clear subscription status
    if (data.exists && data.status === 'subscribed') {
      // SUBSCRIBED
      statusIconEl.className = 'status-icon subscribed';
      statusIconEl.textContent = '‚úì';
      statusTextEl.textContent = 'SUBSCRIBED';
      statusDetailsEl.innerHTML = `
        <p><strong>You are successfully subscribed to our newsletter!</strong></p>
        <p>You'll receive our latest Pharmacy AI insights delivered to your inbox.</p>
        ${data.created_at ? `<p class="subscription-date">Subscribed on: ${new Date(data.created_at).toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        })}</p>` : ''}
      `;
      
      // Hide the old status message and show summary
      statusEl.style.display = 'none';
      subscriptionSummaryEl.style.display = 'block';
      
    } else if (!data.exists) {
      // NOT SUBSCRIBED
      statusIconEl.className = 'status-icon not-found';
      statusIconEl.textContent = '‚úó';
      statusTextEl.textContent = 'NOT SUBSCRIBED';
      statusDetailsEl.innerHTML = `
        <p><strong>You are not yet subscribed to our newsletter.</strong></p>
        <p>Stay updated with the latest Pharmacy AI research and insights by subscribing below.</p>
      `;
      
      statusEl.style.display = 'none';
      subscriptionSummaryEl.style.display = 'block';
      subscribeBtn.style.display = 'inline-block';
      
    } else if (data.exists && data.status === 'pending') {
      // PENDING CONFIRMATION
      statusIconEl.className = 'status-icon pending';
      statusIconEl.textContent = '‚è≥';
      statusTextEl.textContent = 'PENDING CONFIRMATION';
      statusDetailsEl.innerHTML = `
        <p><strong>Your subscription is pending confirmation.</strong></p>
        <p>Please check your email and click the confirmation link to complete your subscription.</p>
        <p>If you don't see the email, check your spam folder.</p>
      `;
      
      statusEl.style.display = 'none';
      subscriptionSummaryEl.style.display = 'block';
      subscribeBtn.style.display = 'inline-block';
      
    } else if (data.exists && data.status === 'unsubscribed') {
      // UNSUBSCRIBED
      statusIconEl.className = 'status-icon unsubscribed';
      statusIconEl.textContent = 'üö´';
      statusTextEl.textContent = 'UNSUBSCRIBED';
      statusDetailsEl.innerHTML = `
        <p><strong>You have unsubscribed from our newsletter.</strong></p>
        <p>Would you like to resubscribe to receive our latest updates?</p>
      `;
      
      statusEl.style.display = 'none';
      subscriptionSummaryEl.style.display = 'block';
      subscribeBtn.style.display = 'inline-block';
      
    } else {
      // OTHER STATUS
      statusIconEl.className = 'status-icon pending';
      statusIconEl.textContent = '‚ùì';
      statusTextEl.textContent = data.status.toUpperCase();
      statusDetailsEl.innerHTML = `
        <p><strong>Your subscription status: ${data.status}</strong></p>
        <p>You have an account but may need to confirm your subscription.</p>
      `;
      
      statusEl.style.display = 'none';
      subscriptionSummaryEl.style.display = 'block';
      subscribeBtn.style.display = 'inline-block';
    }
    
    actionButtons.style.display = 'flex';
    
    // Wire up subscribe button if shown
    if (subscribeBtn.style.display !== 'none') {
      subscribeBtn.addEventListener('click', function() {
        console.log('[check-subscriber] Subscribe button clicked');
        // Trigger the existing subscribe form functionality
        if (typeof showSubscribeForm === 'function') {
          showSubscribeForm();
        } else {
          // Fallback: redirect to home page where subscribe functionality exists
          window.location.href = '{{ .Site.BaseURL }}';
        }
      });
    }
    
  } catch (error) {
    console.error('[check-subscriber] Subscription check failed:', error);
    
    // Show error in subscription summary
    statusIconEl.className = 'status-icon error';
    statusIconEl.textContent = '‚ö†';
    statusTextEl.textContent = 'ERROR';
    statusDetailsEl.innerHTML = `
      <p><strong>Unable to check subscription status</strong></p>
      <p>Please try again later or contact support if the problem persists.</p>
      <p><small>Error: ${error.message}</small></p>
    `;
    
    statusEl.style.display = 'none';
    subscriptionSummaryEl.style.display = 'block';
    actionButtons.style.display = 'flex';
  }
}

// Test function to manually test the API
async function testAPI() {
  console.log('[check-subscriber] Testing API with test email...');
  try {
    const response = await fetch('/.netlify/functions/check-subscriber', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ email: 'test@example.com' })
    });
    
    console.log('[check-subscriber] Test response status:', response.status);
    const data = await response.json();
    console.log('[check-subscriber] Test response data:', data);
  } catch (error) {
    console.error('[check-subscriber] Test API error:', error);
  }
}

// Test function to check Auth0 user
async function testAuth0User() {
  console.log('[check-subscriber] Testing Auth0 user...');
  console.log('[check-subscriber] Available globals:', {
    auth0Client: typeof window.auth0Client,
    createAuth0Client: typeof window.createAuth0Client,
    auth0: typeof window.auth0,
    __AUTH0: window.__AUTH0,
    auth: typeof window.auth
  });
  
  try {
    if (window.auth0Client) {
      const user = await window.auth0Client.getUser();
      console.log('[check-subscriber] Auth0 user test:', user);
      console.log('[check-subscriber] User email:', user?.email);
      console.log('[check-subscriber] All user properties:', Object.keys(user || {}));
    } else {
      console.log('[check-subscriber] Auth0 client not available');
      console.log('[check-subscriber] Trying to create Auth0 client manually...');
      
      if (typeof window.createAuth0Client === 'function' && window.__AUTH0) {
        try {
          const client = await window.createAuth0Client({
            domain: window.__AUTH0.domain,
            clientId: window.__AUTH0.clientId,
            cacheLocation: 'localstorage',
            authorizationParams: {
              redirect_uri: window.location.origin
            }
          });
          console.log('[check-subscriber] Successfully created Auth0 client manually');
          window.auth0Client = client;
          
          const user = await client.getUser();
          console.log('[check-subscriber] Manual Auth0 user test:', user);
        } catch (createError) {
          console.error('[check-subscriber] Failed to create Auth0 client manually:', createError);
        }
      } else {
        console.log('[check-subscriber] Cannot create Auth0 client - missing dependencies');
      }
    }
  } catch (error) {
    console.error('[check-subscriber] Auth0 user test error:', error);
  }
}

// Make test functions available globally for debugging
window.testAPI = testAPI;
window.testAuth0User = testAuth0User;
</script>

<!-- Debug panel for testing -->
<div style="position: fixed; top: 10px; right: 10px; background: #333; color: white; padding: 10px; border-radius: 5px; font-size: 12px; z-index: 9999;">
  <div style="margin-bottom: 5px;">
    <button onclick="testAPI()" style="background: #007cba; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-right: 5px;">Test API</button>
    <button onclick="testAuth0User()" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Test Auth0</button>
  </div>
</div>

{{ end }}
